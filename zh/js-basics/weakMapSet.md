---
tags: ['ES6', 'é¢è¯•é—®é¢˜ - JS']
---

# WeakMap å’Œ WeakSet

> Posted: 10.24.2019

<Tag />

## ä»‹ç»

æˆ‘ä»¬çŸ¥é“ ES6 å¼•å…¥äº† Map å’Œ Set è¿™ä¸¤ä¸ªæ•°æ®ç»“æ„ã€‚

ä½†ä¸€èˆ¬äººä¸çŸ¥é“ï¼ŒES6 è¿˜å¼•å…¥äº† WeakMap å’Œ WeakSetã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¿™ä¿©æ•°æ®ç»“æ„æ¯”èµ· Map å’Œ Setï¼Œåˆ°åº• weak åœ¨å“ªé‡Œäº†å‘¢ï¼Ÿ

å¾ˆç®€å•ï¼ŒWeakMap é‡Œå­˜å‚¨çš„ key ä»¥åŠ WeakSet é‡Œå¯¹è±¡ï¼Œéƒ½æ˜¯<span v-red>**å¼±å¼•ç”¨**</span>ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä»€ä¹ˆæ˜¯ `å¼±å¼•ç”¨`ï¼Ÿ

## WeakMap å’Œ WeakSet çš„ç‰¹æ€§

åœ¨è°ˆå¼±å¼•ç”¨å‰ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬å¿…é¡»è¦äº†è§£ä¸€ä¸‹ WeakMap å’Œ WeakSet çš„ç‰¹æ€§ã€‚

**å¯¹äº WeakMap æ¥è¯´ï¼š**

- WeakMap åªæ¥å—å¯¹è±¡ä½œä¸º keyï¼ˆnullé™¤å¤–ï¼‰ï¼Œä¸æ¥å—å…¶ä»–ç±»å‹çš„å€¼ä½œä¸º key
- è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œæ‰€æœ‰åŸºæœ¬æ•°æ®ç±»å‹çš„å€¼ï¼Œéƒ½æ— æ³•ä½œä¸º WeakMap çš„ key
- ä½†æ˜¯ WeakMap çš„ value æ˜¯ä¸åšä»»ä½•é™åˆ¶çš„

**å¯¹äº WeakSetæ¥è¯´ï¼š**

- WeakSet çš„æˆå‘˜åªèƒ½æ˜¯å¯¹è±¡ï¼Œè€Œä¸èƒ½æ˜¯å…¶ä»–çš„å€¼
- è¿™ä¹Ÿå°±æ„å‘³ç€ï¼ŒWeakSet ä¸æ¥å—æ‰€æœ‰åŸºæœ¬æ•°æ®ç±»å‹çš„å€¼

èªæ˜çš„å°ä¼™ä¼´å¯èƒ½å·²ç»å‘ç°äº†ï¼ŒWeakMap å’Œ WeakSetï¼Œéƒ½åªæ¥å—å¯¹è±¡ã€‚

è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ

è¿™å°±ä¸æˆ‘ä»¬æ¥ä¸‹æ¥è¦è°ˆçš„ `å¼±å¼•ç”¨` æœ‰å…³äº†ã€‚

<span v-line>å› ä¸ºåŸºæœ¬ç±»å‹çš„å€¼ä¸å­˜åœ¨å¼•ç”¨ï¼Œæ›´åˆ«æå¼±å¼•ç”¨</span>

## å‰ææ¡ä»¶

åœ¨è¿™é‡Œï¼Œæˆ‘å¼ºçƒˆå»ºè®®å¤§å®¶å…ˆå»çœ‹æˆ‘å…³äºåƒåœ¾å›æ”¶æœºåˆ¶çš„æ–‡ç« ï¼š[JS çš„åƒåœ¾å›æ”¶æœºåˆ¶](/zh/js-basics/gc.md)ã€‚

å¦‚æœä¸äº†è§£ JS çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œæ¥ä¸‹æ¥çš„ä¸œè¥¿å¯èƒ½ä¼šæ˜¾å¾—å¾ˆè¿·ã€‚

å½“ç„¶ï¼Œå¦‚æœä½ è§‰å¾—å¾ˆè¿·ä¹Ÿæ²¡å…³ç³»ï¼Œé‚£å°±ç»§ç»­çœ‹ä¸‹å»å§ã€‚

## å¼±å¼•ç”¨

ä¸èµ°ç¨‹åºï¼Œç›´æ¥é—®ï¼Œä»€ä¹ˆæ˜¯å¼±å¼•ç”¨ï¼Ÿ

å¼±å¼•ç”¨å°±æ˜¯â€¦â€¦å¼±çš„å¼•ç”¨ã€‚<span v-line>åºŸè¯</span>

è¿™é‡Œéœ€è¦æŠŠ WeakMap å’Œ WeakSet åˆ†å¼€æ¥è®²ã€‚

å› ä¸º WeakSet æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹ WeakSet

### WeakSet

å¯¹äº WeakSet æ¥è¯´ï¼Œå…¶åŒ…å«çš„å¯¹è±¡å¦‚æœåœ¨åˆ«çš„åœ°æ–¹æ²¡æœ‰å¯¹äºè¯¥å¯¹è±¡çš„å¼•ç”¨äº†ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å°±å¯ä»¥è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ã€‚

è€Œå¯¹äºä¸€èˆ¬çš„ Set æ¥è¯´ï¼Œç”±äºå…¶ä¸€ç›´åŒ…å«äº†è¿™äº›å¯¹è±¡ï¼Œå› æ­¤åƒåœ¾å›æ”¶å™¨ä» root å‡ºå‘æ˜¯èƒ½çœ‹è§å®ƒä»¬çš„ï¼Œå› æ­¤ä¼šä¸€ç›´åœç•™åœ¨å†…å­˜ä¸­ã€‚è€Œæœ‰çš„æ—¶å€™ï¼Œè¿™å°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚

æˆ‘ä»¬æ¥ä¸¾ä¸€ä¸ªå°ğŸŒ°ï¼š

```javascript
// ç»™ WeakSet æ·»åŠ å¯¹è±¡
let arr = [1, 2, 3];
const ws = new WeakSet();
ws.add(arr);
// åˆ é™¤å¯¹äºè¯¥å¯¹è±¡çš„å¼•ç”¨
arr = null;
// çŒœçŒœçœ‹ä¼šæ‰“å°ä»€ä¹ˆ...
for (let i = 0; i < 10; ++i) {
  console.log(ws);
}
```

æœ€åæ‰“å°äº† 10 ä¸ªå¦‚ä¸‹çš„å¯¹è±¡ï¼š

![weakset result 1](/weakset-1.png)

...ç­‰ä¸€å“ˆï¼Œè¿™ä¸å¯¹å•Šï¼Ÿä¸æ˜¯è¯´å¥½åƒåœ¾å›æ”¶å™¨ä¼šå›æ”¶åˆ†é…ç»™è¿™ç©æ„å„¿çš„å†…å­˜å—ï¼Ÿ

å…¶å®æ˜¯å› ä¸ºåƒåœ¾å›æ”¶å™¨è¿™ä¸ªæ—¶å€™è¿˜æ²¡æœ‰è¿è¡Œã€‚ä¸ä¿¡çš„è¯ï¼Œæˆ‘ä»¬å¾ªç¯ 100 éè¯•è¯•ã€‚

```javascript
// ç»™ WeakSet æ·»åŠ å¯¹è±¡
let arr = [1, 2, 3];
const ws = new WeakSet();
ws.add(arr);
// åˆ é™¤å¯¹äºè¯¥å¯¹è±¡çš„å¼•ç”¨
arr = null;
// çŒœçŒœçœ‹ä¼šæ‰“å°ä»€ä¹ˆ...
for (let i = 0; i < 100; ++i) {
  console.log(ws);
}
```

![weakset-2](/weakset-2.png)

çœ‹è§æ²¡æœ‰ï¼Œåœ¨åƒåœ¾å›æ”¶å™¨å¼€å¯ä¸€ä¸ªæ–°çš„ cycle åï¼ŒWeakSet é‡Œçš„å¼±å¼•ç”¨å¯¹è±¡è¢«æ¸…é™¤äº†ã€‚

é‚£ä¹ˆï¼Œå¦‚æœæ˜¯æ™®é€šçš„ Set å‘¢ï¼Ÿ

```javascript
let arr = [1, 2, 3];
const set = new Set();
set.add(arr);
arr = null;
for (let i = 0; i < 100; ++i) {
  console.log(set);
}
```

ç»“æœå¦‚ä¸‹ï¼š

![set](/set.png)

æ¯«ä¸æ„å¤–ï¼Œåœ¨ Set ä¸­ï¼Œå¯¹äºè¯¥å¯¹è±¡çš„å¼•ç”¨è¿˜ä¿ç•™ç€ã€‚

çœ‹åˆ°è¿™é‡Œï¼Œå¤§å®¶åº”è¯¥å·²ç»å¯¹ `å¼±å¼•ç”¨` æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£äº†ã€‚

æˆ‘ä»¬å†æ¥çœ‹çœ‹ WeakMapã€‚

### WeakMap

å¯¹äº WeakMap æ¥è¯´ï¼Œå¦‚æœæ²¡æœ‰å¯¹äº key çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå°±ä¼šæ¸…é™¤ key æ‰€å æ®çš„å†…å­˜ã€‚

å¹¶ä¸”ä¼šå°†è¯¥é”®å€¼å¯¹ä» WeakMap ä¸­ç§»é™¤ã€‚

ä½†æ˜¯è¿™å¯¹ value æ²¡æœ‰ä»»ä½•å½±å“ã€‚

```javascript
// æ’å…¥åˆ° WeakMap é‡Œ
let key = [1, 2, 3];
let value = { sb: 'lynch' }
const wm = new WeakMap();
wm.set(key, value);
// æ¸…é™¤å¯¹ key çš„å¼•ç”¨
key = null;
// ç­‰å¾…åƒåœ¾å›æ”¶å™¨æ‰§è¡Œåï¼ŒæŸ¥çœ‹ç»“æœ
setTimeout(() => {
  console.log(wm);
  console.log(value.sb);
}, 5000);
```

ç»“æœå¦‚ä¸‹ï¼š

![weakmap](/wm.png)

æ¯«ä¸æ„å¤–ï¼Œè¯¥é”®å€¼å¯¹ä» WeakMap é‡Œè¢«ç§»é™¤äº†ã€‚

ä½†æ˜¯å½“æˆ‘ä»¬æ‰“å° value.sb çš„æ—¶å€™ï¼Œç»“æœæ­£å¸¸ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œvalue çš„å¼•ç”¨ä¾æ—§å­˜åœ¨ï¼Œå¹¶æ²¡æœ‰è¢«åƒåœ¾å›æ”¶å™¨ç»™å›æ”¶ã€‚

å¯¹äºæ™®é€šçš„ Map æ¥è¯´ï¼Œè‡ªç„¶æ˜¯ä¿ç•™ç€å¼•ç”¨ã€‚

![map](/map.png)

## åº”ç”¨åœºæ™¯

å¦‚æœä½ æƒ³ä¿å­˜ä¸€äº›å¼•ç”¨ï¼Œä½†æ˜¯åˆæ€•å‡ºç°å†…å­˜æ³„æ¼ï¼Œå°±ç”¨ WeakMap/WeakSetã€‚

1. ä»¥ DOM èŠ‚ç‚¹ä½œä¸º keyï¼ˆæ¯”å¦‚è¯´è®°å½•ä¸€ä¸ªèŠ‚ç‚¹è¢«ç‚¹å‡»çš„æ¬¡æ•°ï¼‰

```javascript
const wm = new WeakMap();
const node = document.querySelector('#container');
wm.set(node, 0);
node.addEventListener('click', () => {
  const count = wm.get(node);
  wm.set(node, count + 1);
});
```

2. éƒ¨ç½²ç§æœ‰å±æ€§

```javascript
const _counter = new WeakMap();
const _action = new WeakMap();
class Countdown {
  constructor(counter,action) {
    _counter.set(this, counter);
    _action.set(this, action);
  }

  dec(){
    let counter = _counter.get(this);
    if(counter < 1){
        return ;
    }
    counter --;
    _counter.set(this, counter);
    if(counter === 0){
      _action.get(this)();
    }
  }
}
const c = new Countdown(2, () => console.log('DOWM'));
c.dec();
c.dec(); 
```

ä¸Šé¢ä»£ç ä¸­ï¼ŒCountdown ç±»çš„ä¸¤ä¸ªå†…éƒ¨å±æ€§ _counter å’Œ _actionï¼Œæ˜¯å®ä¾‹çš„å¼±å¼•ç”¨ï¼Œæ‰€ä»¥å¦‚æœåˆ é™¤å®ä¾‹ï¼Œå®ƒä»¬ä¹Ÿå°±éšä¹‹æ¶ˆå¤±ï¼Œä¸ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚

## å…·ä½“ç”¨æ³•

å…·ä½“ç”¨æ³•æˆ‘å°±ä¸è®²äº†ï¼Œè®²äº†ä¹Ÿå¤§æ¦‚ç‡è®°ä¸ä½ã€‚

åæ­£ç­‰åˆ°äº†çœŸè¦ç”¨åˆ°çš„æ—¶å€™ï¼Œå»çœ‹æ–‡æ¡£å°±è¡Œäº†ã€‚

æˆ‘åœ¨è¿™é‡Œå°±ä¸åšæ¬è¿å·¥äº†ã€‚

## å‚è€ƒèµ„æ–™

[WeakMap](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap)

[WeakSet](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakSet)

[What are the actual uses of ES6 WeakMap?](https://stackoverflow.com/questions/29413222/what-are-the-actual-uses-of-es6-weakmap)

[JavaScriptES6Mapä¸WeakMap](https://blog.csdn.net/c__dreamer/article/details/82182649)

[JavaScriptES6çš„Setä¸WeakSet](https://blog.csdn.net/c__dreamer/article/details/82182200)

<Disqus />